<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Вход / Регистрация</title>
  <link rel="stylesheet" href="css/auth.css" />
</head>

<script>
  document.getElementById('loginForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ identifier: username, password: password })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          localStorage.setItem('user', JSON.stringify({
            id: data.userId,
            username: data.username,
            display_name: data.displayName
          }));
          window.location.href = 'messenger.html';
        } else {
          alert(data.error || 'Ошибка входа');
        }
      });
  });

  document.getElementById('registerForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const displayName = document.getElementById('regDisplayName').value.trim();
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const password2 = document.getElementById('regPassword2').value;

    if (password !== password2) {
      alert('Пароли не совпадают');
      return;
    }

    fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ displayName, username, password, password2 })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Регистрация успешна! Теперь войдите.');
          document.getElementById('registerForm').reset();
        } else {
          alert(data.error || 'Ошибка регистрации');
        }
      });
  });
</script>

<body>
  <!-- Форма входа -->
  <form id="loginForm">
    <div class="form-group">
      <label for="loginUsername">Имя пользователя</label>
      <input type="text" id="loginUsername" name="username" required>
    </div>
    <div class="form-group">
      <label for="loginPassword">Пароль</label>
      <input type="password" id="loginPassword" name="password" required>
    </div>
    <button type="submit" class="btn btn-primary">Войти</button>
  </form>

  <!-- Форма регистрации -->
  <form id="registerForm">
    <div class="form-group">
      <label for="regDisplayName">Отображаемое имя</label>
      <input type="text" id="regDisplayName" name="displayName" required>
    </div>
    <div class="form-group">
      <label for="regUsername">Имя пользователя (@...)</label>
      <input type="text" id="regUsername" name="username" required>
    </div>
    <div class="form-group">
      <label for="regPassword">Пароль</label>
      <input type="password" id="regPassword" name="password" required>
    </div>
    <div class="form-group">
      <label for="regPassword2">Подтвердите пароль</label>
      <input type="password" id="regPassword2" name="password2" required>
    </div>
    <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
  </form>

  <script type="module" src="js/core/auth.js"></script>
</body>

</html>